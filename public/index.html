<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - Sistema de Riego</title>

  <script src="https://cdn.jsdelivr.net/npm/raphael@2.3.0/raphael.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/justgage@1.3.5/justgage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Chart.js para histórico -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background-color:#b2d8b2; }
    header { text-align:center; background:#2c3e50; color:white; padding:1rem; }
    .gauges { display:flex; flex-wrap:wrap; justify-content:center; gap:0.5rem; padding:0.5rem; }
    .gauge-container { flex:1 1 45%; max-width:45%; text-align:center; background:white; border-radius:8px; padding:0.5rem; box-shadow:0 2px 5px rgba(0,0,0,0.2); margin-bottom:0.5rem; }
    .gauge-container h3 { margin:0.3rem 0; font-size:0.9rem; }
    #alertas { width:95%; margin:0.5rem auto; padding:0.4rem; background-color:#f5f5f5; border-radius:5px; text-align:center; font-weight:bold; min-height:1.5em; }
    table { width:95%; margin:1rem auto; border-collapse:collapse; font-size:0.8rem; }
    th, td { padding:0.3rem; text-align:center; border:1px solid #ccc; }
    thead th { background-color:#006400; color:white; }
    #export-buttons { text-align:center; margin:1rem 0; }
    #export-buttons button { margin:0 0.3rem; padding:0.4rem 0.8rem; font-size:0.9rem; border:none; border-radius:5px; background:#2c3e50; color:white; cursor:pointer; }
    #export-buttons button:hover { background:#1a252f; }
    @media (max-width:600px) { .gauge-container { flex:1 1 90%; max-width:90%; } }
  </style>
</head>
<body>
  <header>
    <h1>Sistema de Riego</h1>
    <p id="status"></p>
  </header>

  <!-- HISTÓRICO NIVEL DE AGUA -->
  <section style="width:95%; margin:1rem auto; background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
    <h2 style="text-align:center;">Histórico del Nivel de Agua</h2>
    <canvas id="histAgua" height="120"></canvas>
  </section>

  <section class="gauges">
    <div class="gauge-container"><h3>Humedad Suelo</h3><div id="gauge_suelo"></div></div>
    <div class="gauge-container"><h3>Nivel Agua</h3><div id="gauge_agua"></div></div>
    <div class="gauge-container"><h3>Temperatura</h3><div id="gauge_temp"></div></div>
    <div class="gauge-container"><h3>Humedad Aire</h3><div id="gauge_hum"></div></div>
  </section>

  <div id="alertas"></div>

  <div id="export-buttons">
    <button id="exportCsv">Exportar CSV</button>
    <button id="exportExcel">Exportar Excel</button>
  </div>

  <section>
    <h2 style="text-align:center;">Últimos 10 registros</h2>
    <table>
      <thead>
        <tr>
          <th>Suelo</th>
          <th>Agua</th>
          <th>Temp</th>
          <th>Hum</th>
          <th>Fecha</th>
        </tr>
      </thead>
      <tbody id="tabla"></tbody>
    </table>
  </section>

  <script>
    // === HISTÓRICO DEL NIVEL DE AGUA ===
    let aguaHistory = [];
    let labelHistory = [];

    let ctxAgua;
    let chartAgua;

    function initChartAgua() {
      ctxAgua = document.getElementById("histAgua").getContext("2d");

      chartAgua = new Chart(ctxAgua, {
        type: 'line',
        data: {
          labels: labelHistory,
          datasets: [{
            label: "Nivel de Agua (%)",
            data: aguaHistory,
            borderWidth: 2,
            borderColor: "#007BFF",
            backgroundColor: "rgba(0,123,255,0.2)",
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    }

    function actualizarChartAgua(valorAgua) {
      const hora = new Date().toLocaleTimeString();

      if (aguaHistory.length > 20) {
        aguaHistory.shift();
        labelHistory.shift();
      }

      aguaHistory.push(valorAgua);
      labelHistory.push(hora);

      chartAgua.update();
    }

    // ==== COLORES ====
    function getColorCustom(value, max, type) {
      const percent = Math.min(Math.max(value / max, 0), 1);
      switch(type) {
        case "suelo": return "#8B4513";
        case "agua": return "#007BFF";
        case "temp": return `rgb(${255*percent},${165 + (90*percent)},0)`;
        case "hum": return `rgb(0, ${128 + (127*percent)}, 255)`;
      }
      return "#000";
    }

    // === GAUGES ===
    let gSuelo, gAgua, gTemp, gHum;

    function initGauges() {
      gSuelo = new JustGage({ id:"gauge_suelo", value:0, min:0, max:100, label:"%" });
      gAgua  = new JustGage({ id:"gauge_agua", value:0, min:0, max:100, label:"%" });
      gTemp  = new JustGage({ id:"gauge_temp", value:0, min:0, max:60, label:"°C" });
      gHum   = new JustGage({ id:"gauge_hum", value:0, min:0, max:100, label:"%" });
    }

    function actualizarGauges(suelo, agua, temp, hum) {
      gSuelo.refresh(Number(suelo)||0);
      gAgua.refresh(Number(agua)||0);
      gTemp.refresh(Number(temp)||0);
      gHum.refresh(Number(hum)||0);

      actualizarChartAgua(Number(agua)); // ← Histórico

      let mensaje = "✔️ Todo en rango";
      let color = "#228B22";

      if (suelo < 25 && agua < 25) { mensaje = "⚠️ Bajo nivel de agua y suelo seco"; color = "red"; }
      else if (suelo < 25) { mensaje = "⚠️ Humedad del suelo baja"; color = "orange"; }
      else if (agua < 25) { mensaje = "⚠️ Nivel de agua bajo"; color = "orange"; }

      document.getElementById("alertas").textContent = mensaje;
      document.getElementById("alertas").style.color = color;
    }

    // === ACTUALIZAR DATOS ===
    async function actualizar() {
      try {
        const res = await fetch("/api/ultimos");
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById("tabla").innerHTML = `<tr><td colspan="5">No hay registros</td></tr>`;
          actualizarGauges(0,0,0,0);
          return;
        }

        const ultimo = data[0];
        actualizarGauges(ultimo.suelo, ultimo.agua, ultimo.temp, ultimo.hum);

        document.getElementById("tabla").innerHTML = data.map(r => `
          <tr>
            <td>${r.suelo}%</td>
            <td>${r.agua}%</td>
            <td>${r.temp}°C</td>
            <td>${r.hum}%</td>
            <td>${new Date(r.fecha).toLocaleString()}</td>
          </tr>
        `).join("");

      } catch(e){ console.error(e); }
    }

    initChartAgua();
    initGauges();
    actualizar();
    setInterval(actualizar, 1000);

    // === EXPORT CSV/EXCEL ===
    document.getElementById('exportCsv').addEventListener('click', () => exportData('csv'));
    document.getElementById('exportExcel').addEventListener('click', () => exportData('excel'));

    async function exportData(type) {
      try {
        const res = await fetch("/api/ultimos");
        const data = await res.json();

        if(type === 'csv') {
          const csvContent = convertToCSV(data);
          downloadFile(csvContent, 'datos.csv', 'text/csv');
        } else if(type === 'excel') {
          const ws = XLSX.utils.json_to_sheet(data);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Datos');
          XLSX.writeFile(wb, 'datos.xlsx');
        }
      } catch(e){ console.error(e); }
    }

    function convertToCSV(objArray) {
      const array = Array.isArray(objArray) ? objArray : [objArray];
      const header = Object.keys(array[0] || {}).join(',');
      const rows = array.map(obj => Object.values(obj).join(','));
      return [header, ...rows].join('\n');
    }

    function downloadFile(content, fileName, mimeType) {
      const a = document.createElement('a');
      const blob = new Blob([content], { type: mimeType });
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      a.click();
    }
  </script>
</body>
</html>





